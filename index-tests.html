<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Evaluaci√≥n Matem√°tica</title>
    
    <script>
        window.MathJax = {
            loader: { load: ['[tex]/ams'] },
            tex: {
                packages: {'[+]': ['ams']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: { fontCache: 'global' },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #1e293b;
            --accent: #10b981;
            --warning-bg: #fff7ed;
            --warning-text: #c2410c;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --card-bg: rgba(255, 255, 255, 0.98);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            display: flex;
            flex-direction: column; /* Para empujar el footer abajo */
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        /* CONTENEDOR PRINCIPAL */
        .app-container {
            width: 95%; /* Un poco m√°s ancho en m√≥viles */
            max-width: 800px;
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            overflow: visible;
            overflow-y: auto;
            max-height: 85vh; /* Dejamos espacio para el footer */
            position: relative;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.8);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        /* Footer Placeholder Styles */
        #common-footer-placeholder {
            width: 100%;
            margin-top: auto; /* Empuja el footer al final */
            z-index: 100;
        }

        /* BARRA DE PROGRESO */
        .progress-container { height: 6px; background: #e2e8f0; width: 100%; position: sticky; top: 0; z-index: 10;}
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }

        /* PANTALLAS */
        .screen { padding: 40px; flex: 1; display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s ease; }
        .screen.active { display: flex; opacity: 1; }

        /* INPUTS */
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; }
        .form-control { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #f8fafc; box-sizing: border-box; }
        .form-control:focus { border-color: var(--primary); background: #fff; outline: none; }

        /* BOTONES */
        .btn {
            background: var(--primary); color: white; border: none; padding: 16px 32px;
            border-radius: 14px; font-size: 1.1rem; font-weight: 700; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); width: 100%;
            display: inline-flex; justify-content: center; align-items: center; margin-top: 20px;
        }
        .btn:hover { transform: translateY(-2px); background: var(--primary-dark); }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: white; color: #475569; border: 2px solid #e2e8f0; box-shadow: none; }
        .btn-secondary:hover { background: #f1f5f9; }

        /* PREGUNTAS */
        .q-image { width: 100%; max-height: 250px; object-fit: contain; margin-bottom: 25px; border-radius: 12px; display: block; }
        .question-text { font-size: 1.35rem; font-weight: 600; color: var(--secondary); line-height: 1.6; margin-bottom: 30px; }
        
        .question-text.style-warning { background: var(--warning-bg); color: var(--warning-text); padding: 20px; border-left: 5px solid #f97316; border-radius: 8px; }
        .question-text.style-hero { font-size: 1.8rem; text-align: center; color: #111827; }

        /* GRID OPCIONES */
        .options-grid { display: grid; gap: 15px; margin-bottom: 40px; }
        .options-grid.layout-standard { grid-template-columns: 1fr 1fr; } 
        .options-grid.layout-list { grid-template-columns: 1fr; }
        .options-grid.layout-bool { grid-template-columns: 1fr 1fr; gap: 30px; }

        @media (max-width: 600px) {
            .options-grid.layout-standard, .options-grid.layout-bool { grid-template-columns: 1fr; }
            .screen { padding: 30px 20px; }
        }

        .option-card { padding: 20px 25px; border: 2px solid #f1f5f9; border-radius: 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; background: #fff; min-height: 60px; }
        .option-card:hover { border-color: var(--primary); background: #f8fafc; }
        .option-card.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: 700; }
        
        .opt-letter { width: 32px; height: 32px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: 700; color: #64748b; font-size: 0.9rem; flex-shrink: 0; }
        .selected .opt-letter { background: var(--primary); color: white; }

        /* RESULTADOS */
        .score-box { text-align: center; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 20px; }
        .score-number { font-size: 3.5rem; font-weight: 800; color: var(--primary); display: block;}
        
        .result-item { padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #e2e8f0; background: white; }
        .result-item.correct { border-left: 5px solid var(--accent); background: #f0fdf4; }
        .result-item.wrong { border-left: 5px solid #ef4444; background: #fef2f2; }
        .explanation { margin-top: 10px; padding: 12px; background: #fffbeb; border-radius: 8px; font-size: 0.95rem; color: #92400e; border: 1px solid #fcd34d; }

        /* LOADER */
        .loader { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>

    <div id="screen-login" class="screen active">
        <div style="text-align:center; margin-bottom:30px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">üìê</div>
            <h1 style="margin:0; color:var(--secondary);">Aula Matem√°tica</h1>
            <p style="color:#64748b;">Evaluaci√≥n Interactiva Personalizada</p>
        </div>
        
        <div class="input-group">
            <label>Nombre y Apellidos</label>
            <input type="text" id="studentName" class="form-control" placeholder="Ej: Alex L√≥pez">
        </div>

        <div class="input-group">
            <label>Curso</label>
            <select id="studentClass" class="form-control">
                <option value="" disabled selected>Selecciona tu grupo...</option>
                <option value="1ESO_A">1¬∫ E.S.O. A</option>
                <option value="1ESO_B">1¬∫ E.S.O. B</option>
                <option value="1ESO_C">1¬∫ E.S.O. C</option>
            </select>
        </div>

        <div class="input-group">
            <label>Cuestionario</label>
            <select id="quizSelector" class="form-control">
                <option value="" disabled selected>Cargando cuestionarios...</option>
            </select>
        </div>

        <button class="btn" onclick="app.start()">Comenzar Prueba ‚ûî</button>
    </div>

    <div id="screen-quiz" class="screen">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:0.9rem; font-weight:700; color:#94a3b8;">
            <span id="quiz-title-display">T√çTULO</span>
            <span id="question-badge">1/10</span>
        </div>
        <div id="dynamic-content">
            <div id="image-container"></div>
            <div id="question-text" class="question-text"></div>
        </div>
        <div id="options-container" class="options-grid"></div>
        <div style="margin-top:auto; text-align:right;">
            <button id="btn-next" class="btn" style="width:auto; padding: 12px 25px;" onclick="app.next()" disabled>Siguiente</button>
        </div>
    </div>

    <div id="screen-loading" class="screen" style="justify-content:center; text-align:center;">
        <div class="loader"></div>
        <h3 style="color:var(--secondary);">Procesando respuestas...</h3>
    </div>

    <div id="screen-results" class="screen">
        <div class="score-box">
            <span style="display:block; font-size:0.9rem; font-weight:700; color:#64748b; margin-bottom:10px;">CALIFICACI√ìN</span>
            <span class="score-number" id="final-score">0</span>
            <span style="font-size:1.2rem; color:#64748b;">/ 10</span>
        </div>
        <div id="result-list"></div>
        <button class="btn btn-secondary" onclick="app.restart()">‚Üª Realizar otra prueba</button>
    </div>
</div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

<div id="common-footer-placeholder"></div>
<script>
    // Configuraci√≥n de Google Translate con NL
    window.googleTranslateElementInit = function() {
        new google.translate.TranslateElement({
            pageLanguage: 'es', 
            includedLanguages: 'en,fr,de,ar,nl,es,ru,uk,pl,zgh',
            autoDisplay: false,
            gaTrack: false 
        }, 'google_translate_element');
    };

    const footerUrl = 'https://jgamort408-web.github.io/profesor/footer.html?v=' + new Date().getTime(); 

    fetch(footerUrl)
        .then(response => {
            if (!response.ok) throw new Error('Error footer');
            return response.text();
        })
        .then(data => {
            document.getElementById('common-footer-placeholder').innerHTML = data;
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
            document.body.appendChild(script);
        })
        .catch(error => console.error(error));
</script>
<script>
    // --- URL DEL JSON EXTERNO ---
    const JSON_URL = 'https://jgamort408-web.github.io/profesor/ltdi-tests.json' + new Date().getTime(); 

    // --- GOOGLE FORMS CONFIG ---
    const FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSfnOqtmoR1O2PEr015Z6E9AvhqSKndtl5SarFvXdoH_MgjB9w/formResponse";
    const NAME_ID = "entry.1604683409"; 
    const CLASS_ID = "entry.1070552838"; 
    const SCORE_ID = "entry.921447464"; 
    const SECURITY_TOKEN_ID = "entry.905688710";
    
    const QUESTION_IDS = [
        "entry.2117626835", "entry.132798763", "entry.219751648", "entry.1505720170", 
        "entry.240133323", "entry.1939103034", "entry.717168251", "entry.1464491326", 
        "entry.195986424", "entry.1063045561"
    ];

    // Variable global para almacenar los tests descargados
    let ALL_QUIZZES = {}; 

    // --- L√ìGICA DE LA APLICACI√ìN ---
    const app = {
        state: { 
            quizId: null, 
            studentName: "", 
            studentClass: "", 
            answers: [], 
            currentIdx: 0 
        },

        init: function() {
            // Cargar datos externos
            fetch(JSON_URL)
                .then(response => {
                    if (!response.ok) throw new Error("No se pudo cargar el archivo de cuestionarios");
                    return response.json();
                })
                .then(data => {
                    ALL_QUIZZES = data;
                    this.populateSelector();
                })
                .catch(err => {
                    console.error(err);
                    const sel = document.getElementById('quizSelector');
                    sel.innerHTML = '<option disabled>Error cargando datos. Revisa la consola.</option>';
                });
        },

        populateSelector: function() {
            const sel = document.getElementById('quizSelector');
            sel.innerHTML = '<option value="" disabled selected>Selecciona un examen...</option>';
            for (const [key, val] of Object.entries(ALL_QUIZZES)) {
                const opt = document.createElement('option');
                opt.value = key; opt.innerText = val.title;
                sel.appendChild(opt);
            }
        },

        start: function() {
            const name = document.getElementById('studentName').value;
            const clase = document.getElementById('studentClass').value;
            const qId = document.getElementById('quizSelector').value;

            if(!name.trim()) { alert("‚ö†Ô∏è Escribe tu nombre."); return; }
            if(!clase) { alert("‚ö†Ô∏è Selecciona tu curso."); return; }
            if(!qId || !ALL_QUIZZES[qId]) { alert("‚ö†Ô∏è Selecciona un cuestionario v√°lido."); return; }

            this.state.studentName = name;
            this.state.studentClass = clase;
            this.state.quizId = qId;
            this.state.currentIdx = 0;
            this.state.answers = new Array(ALL_QUIZZES[qId].questions.length).fill(null);

            this.switchScreen('screen-quiz');
            this.renderQuestion();
        },

        renderQuestion: function() {
            const quiz = ALL_QUIZZES[this.state.quizId];
            const idx = this.state.currentIdx;
            const data = quiz.questions[idx];
            const labelsVisual = ['a', 'b', 'c', 'd'];
            
            // Header
            document.getElementById('quiz-title-display').innerText = quiz.title.toUpperCase();
            document.getElementById('question-badge').innerText = `${idx + 1} / ${quiz.questions.length}`;
            document.getElementById('progress-bar').style.width = `${((idx) / quiz.questions.length) * 100}%`;

            // Imagen
            const imgContainer = document.getElementById('image-container');
            if (data.image) {
                imgContainer.innerHTML = `<img src="${data.image}" class="q-image" alt="Imagen adjunta">`;
                imgContainer.style.display = 'block';
            } else {
                imgContainer.innerHTML = ''; imgContainer.style.display = 'none';
            }

            // Texto
            const qTextDiv = document.getElementById('question-text');
            qTextDiv.innerHTML = data.q;
            qTextDiv.className = 'question-text'; 
            if(data.style) qTextDiv.classList.add(`style-${data.style}`);

            // Opciones y Layout
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            container.className = 'options-grid'; 
            const layoutType = data.layout || 'standard';
            container.classList.add(`layout-${layoutType}`);

            data.options.forEach((opt, i) => {
                const div = document.createElement('div');
                const isSelected = this.state.answers[idx] === i;
                div.className = `option-card ${isSelected ? 'selected' : ''}`;
                div.onclick = () => this.selectAnswer(i, div);
                
                let letterHtml = `<div class="opt-letter">${labelsVisual[i]}</div>`;
                if (layoutType === 'bool') letterHtml = ''; 

                div.innerHTML = `${letterHtml}<div style="width:100%">${opt}</div>`;
                container.appendChild(div);
            });

            const btn = document.getElementById('btn-next');
            btn.disabled = (this.state.answers[idx] === null);
            btn.innerText = (idx === quiz.questions.length - 1) ? "Finalizar Examen" : "Siguiente";

            if(window.MathJax) MathJax.typesetPromise([document.getElementById('screen-quiz')]);
        },

        selectAnswer: function(optIdx, el) {
            this.state.answers[this.state.currentIdx] = optIdx;
            const siblings = document.getElementById('options-container').children;
            for(let s of siblings) s.classList.remove('selected');
            el.classList.add('selected');
            document.getElementById('btn-next').disabled = false;
        },

        next: function() {
            const quiz = ALL_QUIZZES[this.state.quizId];
            if(this.state.currentIdx < quiz.questions.length - 1) {
                this.state.currentIdx++;
                const screen = document.getElementById('screen-quiz');
                screen.style.opacity = '0';
                setTimeout(() => {
                    this.renderQuestion();
                    screen.style.opacity = '1';
                }, 250);
            } else {
                this.finish();
            }
        },

        finish: function() {
            this.switchScreen('screen-loading');
            const quiz = ALL_QUIZZES[this.state.quizId];
            let correctCount = 0;
            quiz.questions.forEach((q, i) => { if(this.state.answers[i] === q.correct) correctCount++; });
            const finalScore = ((correctCount / quiz.questions.length) * 10).toFixed(1);

            this.submitToGoogle(finalScore);
            setTimeout(() => { this.showResults(finalScore); }, 1500);
        },

        submitToGoogle: function(score) {
            const quiz = ALL_QUIZZES[this.state.quizId];
            const submitLabels = ['a', 'b', 'c', 'd'];

            const form = document.createElement('form');
            form.action = FORM_ACTION; form.method = 'POST'; form.target = 'hidden_iframe'; form.style.display = 'none';
            const add = (n, v) => { const i = document.createElement('input'); i.name = n; i.value = v; form.appendChild(i); };

            add(NAME_ID, this.state.studentName);
            add(CLASS_ID, this.state.studentClass);
            add(SCORE_ID, score);

            this.state.answers.forEach((ans, i) => {
                if(i < QUESTION_IDS.length && ans !== null) {
                    add(QUESTION_IDS[i], submitLabels[ans]);
                }
            });
            const token = quiz.questions.map(q => q.correct).join("");
            add(SECURITY_TOKEN_ID, token);
            document.body.appendChild(form);
            form.submit();
        },

        showResults: function(score) {
            const quiz = ALL_QUIZZES[this.state.quizId];
            document.getElementById('final-score').innerText = score;
            const container = document.getElementById('result-list');
            container.innerHTML = '';
            const labels = ['a', 'b', 'c', 'd'];

            quiz.questions.forEach((q, i) => {
                const myAns = this.state.answers[i];
                const isCorrect = (myAns === q.correct);
                const item = document.createElement('div');
                item.className = `result-item ${isCorrect ? 'correct' : 'wrong'}`;
                item.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:8px; color:#334155;">${i+1}. ${isCorrect ? 'Correcto ‚úÖ' : 'Incorrecto ‚ùå'}</div>
                    <div style="margin-bottom:10px; font-size:1.1rem;">${q.q}</div>
                    <div style="font-size:0.9rem; margin-bottom:10px; color:#475569;">
                        Tu respuesta: <b>${labels[myAns]}</b> ${!isCorrect ? `| Correcta: <b>${labels[q.correct]}</b>` : ''}
                    </div>
                    <div class="explanation">üí° ${q.explanation || ''}</div>
                `;
                container.appendChild(item);
            });

            this.switchScreen('screen-results');
            if(window.MathJax) MathJax.typesetPromise([document.getElementById('screen-results')]);
            document.getElementById('progress-bar').style.width = '100%';
        },

        restart: function() {
            this.state.answers = []; this.state.currentIdx = 0;
            this.switchScreen('screen-login');
            document.getElementById('progress-bar').style.width = '0%';
        },

        switchScreen: function(id) {
            document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); setTimeout(() => { if(!s.classList.contains('active')) s.style.display = 'none'; }, 300); });
            const target = document.getElementById(id);
            target.style.display = 'flex';
            setTimeout(() => target.classList.add('active'), 50);
        }
    };

    // Iniciar App cargando el JSON
    window.onload = () => app.init();
</script>
</body>
</html>
